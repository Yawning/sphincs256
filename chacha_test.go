// chacha_test.go - ChaCha12 test vectors

package sphincs256

import (
	"bytes"
	"encoding/hex"
	"testing"
)

func TestChachaKeystreamBytes(t *testing.T) {
	// Test vectors liberated from the academic oppressors at Stanford.  Not
	// exhaustive, just enough to satisfy myself that the implementation works.
	//
	// See: https://github.com/stbuehler/sjcl/blob/718dcb3a140ff73eabdd16d187d1fdb804e024df/test/chacha_vectors.js
	type vector struct {
		key        string
		nonce      string
		begining   string
		preMiddle  string
		postMiddle string
		end        string
		xorSum     string
		msgLen     int
	}

	vectors := []vector{
		// 128 bit key

		// Set 1, vector# 0:
		{
			"80000000000000000000000000000000", "0000000000000000",
			"36CF0D56E9F7FBF287BC5460D95FBA94AA6CBF17D74E7C784DDCF7E0E882DDAE3B5A58243EF32B79A04575A8E2C2B73DC64A52AA15B9F88305A8F0CA0B5A1A25",
			"83496792AB68FEC75ADB16D3044420A4A00A6E9ADC41C3A63DBBF317A8258C85A9BC08B4F76B413A4837324AEDF8BC2A67D53C9AB9E1C5BC5F379D48DF9AF730",
			"BAA28ED593690FD760ADA07C95E3B8884B4B64E488CA7A2D9BDC262243AB9251394C5037E255F8BCCDCD31306C508FFBC9E0161380F7911FCB137D46D9269250",
			"B7ECFB6AE0B51915762FE1FD03A14D0C9E54DA5DC76EB16EBA5313BC535DE63DC72D7F9F1874E301E99C8531819F4E3775793F6A5D19C717FA5C78A39EB804A6",
			"208AD114ADB94F818274ED575FC54ED9C715D808AD2B62203FC70A38B438AD0F20319B22EFA453A1C380447AB9A29F69A58E25E49803B68F870419BF7C10C977",
			512,
		},
		// Set 1, vector# 9:
		{
			"00400000000000000000000000000000", "0000000000000000",
			"D609433831BC85E388B99865A618BC85589EFC9D0D945D68AEC4D59753EFB4982F7B1A8997B93DF81FF2867A6DDFFFB1A0D0D88C2A1B697A4FD16E3AA956B500",
			"9C01CE3CB94BC50D6BAFF1663AAAA9D4ADA13FACFB891F9CFF75D6D9F71F123AE5E8C4E84C4793CFF0A799DA6F315D417C99880108BC05D7CFB303D9CC98C3F6",
			"01B4FCD519415A5C6D6D9680F106BAEAD6489E1B65A954AE284E8E2B57AE4C8C7A0B9A6B9ED3C12AFFBB39452E905CD6B551931585B64140085BE7BAB9CDD15C",
			"267E65D242934957B2B6230E64240EF1E292E40B6C5FB0B26A0048830A177BB9E0F132EBD803EA4535672919FC88D446C9B14F6FF9888A413BD88C979D8F2912",
			"9A267FD3CF2D85D239EF5C4B659E67DAD13E3716EB20E7E475376DD269F900D25B78D1FA37496EB0CD7A7826E208D7A3240E75B95DB3EB57BA12FBD154A63C97",
			512,
		},
		// Set 1, vector# 18:
		{
			"00002000000000000000000000000000", "0000000000000000",
			"C4EE4DE61E630CF5F61F8CF49C79BC12583F55527174146F0392053BC62EFAA209B70A5F5CCE6E1ED4F003C55EF60A212CB3A4E28F6A08FB44B774F3ED0595DA",
			"6B722C7ABFBB4EF2B45F6FC06595196F5523E664E1C5B26E4D4F1E20296B489E6A4C4C45C626177816C5D0C0E7C702EF4D41E9BAA6BCF963A23710C9338EFA60",
			"D7C0C5FDD4D1A6247C73E61074C16D82C9358060DA6B4D0EC2897DCC110C8A6ABDC5B06E49399450D7AB4888C9DA8562BC06BB047359E0E9B858E9C187C05A8D",
			"54F950DC9E0E9F736153954091806594DCFEECA829CCA3A1D45DBDCE45F31380CCB4CD306BAE35F2F2C6972FADB1D40D7B859461C2314F8653787DBFA67A4448",
			"3F35E917AD46AE515166C6A118F088943A47C3611F130FAFBC5ACDE9A1A997E952EA764A1388E200F4E0089E9EE42643C85E9C7D39FE822ADF89554C44CBC411",
			512,
		},
		// Set 1, vector# 27:
		{
			"00000010000000000000000000000000", "0000000000000000",
			"E2BEA07C9EE226A12960B230B36181740FE1AD585B26E0B6F414A6F7BFA627BD3539ECB07157AD901F510FD338238DBCD8A15EC5FC5B3A2C6ABC310761ADF2CA",
			"28A21CEAD50BA43245B60683D3B03C4436666AA3BD2F7B9CA9B20A028AFD606FC83989FFFB510ABA2F0BE02D4ECE7EECCDD609D63280692D7E474C4F7203107A",
			"25ADF43E6D5BEA9BE63ECC728686BC0F24B940EC1DA0D87D30D61E911F6E0AC2099C9A66BE02AB41C3A0400702A4A94DA2AD3363A65B71F4DE7E4E19BD620A1E",
			"B5CFAFBF4DC0D72029625E26E62CEB61EDC5F21BC885345CCB222C3E8735D951F548C29F4BAF9EF2C4EDB57B1711BC6F5AC0EA3EC59819CF0A2A35496599D17A",
			"EFE647BA6A4403EA81D34E29773D7D6A51EFA86A398932FFD3E47B0537951A353B82AADB824170379692449FC8CA57AE85C4E4DAA0BFEE5853D0B86588A165E1",
			512,
		},
		// Set 1, vector# 36:
		{
			"00000000080000000000000000000000", "0000000000000000",
			"CDB9D9A62ADE4984B96EC0AC979B6FD4D9CC6A1E123D2B56F768937CDC6468DB269466A74B111E18FA77FACC3225B515E00BBE2BD61C4870CF8297ED6B6164F0",
			"96457F3B50C193D3F5E89795BD7323CCC38C4258447EC07F09CE111F38C665D6EA238FFC6A91792B9C8B6318274447038700AE2E92F05D8459F08F701DFBCA03",
			"6D39180CE54374AA13EFEF3DFD1164AB840DEAA8C5B2510A6F877E3B9A9E7CE3A879C0E5270930D4B2D29087F9588C0B89426CF85BCBC7E2842EC0A49DD88A1A",
			"2BBBD59F76C662C9CED71F85C461E3492C8513B1BD9C8C0231162B74AA8C8565A60E5E36D4D219FD3C5A5C95C4FDA67F9A2B8FA9770D55D49819A0359C7D8E39",
			"F049C877E81749D4447784EB7C1C67E3BF3B5F68CB7A0F5CBA57EA3305019B91DECB6EDBE1868C354D306B7B3249F28EB2E21E4532FE7BC8D80F3F6A5FEC904E",
			512,
		},
		// Set 1, vector# 45:
		{
			"00000000000400000000000000000000", "0000000000000000",
			"9496C6E4EBB0B9E081BA1D8B44EE975B45182EAA199C3C35C611F690EF7D027B84114E10C069FF51E8021713FD338BB4DF5A1C79A09BFBE63F22278844999901",
			"4CC93301C5ECE6962109563CD18923B8F68560A76619505A01BB348A7E4E4280877F69D09708C506431FEA968F809479528A80A924B498096B260786437CBF50",
			"C76BAFBA6F19B2835B2B6FA5D6A50FCE6903FA2366B4110B31AE145522E5C47FCDEB0254C6EE3D7577B584FE465681045A248DC1F929230FC39967C7EC42589D",
			"B7A1FC50B33A2AE64D77F1353DDB6A5471833CEC2AC2E885A215258C5F3A01913BAE9DEF60B101F4E80C0D931CECD53DDB7F7616A58D6F8B0BFAC1AF3C130601",
			"F39BF2E9F0252E93FB80437850AAE8784E0F65C558F4DA4CD776972D30A493D20AAE079A7F63D240C5045FC57DC1DB913F076A6741085920AC7FD69D8ED77B7C",
			512,
		},
		// Set 1, vector# 54:
		{
			"00000000000002000000000000000000", "0000000000000000",
			"1E1108FF341B588E490C080D73DE66C063D272D8FB71D8C27982DE12063A7C4C2E7F51CCF774919F151167242FEF5CABED38977E82891DCD6B5A815C9253CF38",
			"D80BF76EC11B5DB710DFE5D9CDEB1AA1EE71D587D8CFCCE7D2EF8325E8415D7C883E7F94F5EC3634F45549AAA019E457181D1EED4ACD89A522EA1631F5545D36",
			"0418EEA7EBBBEA13849A60FF825883B664FA0E6FA2537ABA1F2D586E1BF28F228182F260DBBF6F7EA70BB2C380339BB234890F18FA0E3932F560B9C6F9A83B77",
			"C155AEDD15E85BDD8352BE8186CFA9241758D52018C3C84437FA8320865E7740B513FB4C5296208549EB297536D71D77D4F612E0B2632B6A63AE69F4FE0E4994",
			"0A14A647A49BA16C00BCA84992DFE2EE9E56ACD0DC5A1EB693BC5ED329A68C330C0B76E437AD668C4112F0BDCFDC41CECBA6FEB698EDA295105CECF33AA8E84F",
			512,
		},
		// Set 1, vector# 63:
		{
			"00000000000000010000000000000000", "0000000000000000",
			"E7E1B48D570A9B5F8702C7620F65E40D5FF2BA0F4AEA96C20B4DF12FF62EBC388A63E05DFA529E63ACCB1DABBE767C2802FC1E60ADF547B316488806FD1E6F51",
			"64BE60F0BE72EB22FA67A3DFD7F4A76FB6976A3CC7361D7E066CC995F5DDAB0E9E514C8D13F2E1C44F5205BAB708A8B93E1AD90A318A4DEE8FD39D3F000F1EA8",
			"315A9E959B554210FF7D82F7DF4E0AB4D90F6AB1913AE7ABCBAB30DBBCD21B79B46DD97FA8E418D764F1EED7F03F7AAC998E5955FEB509CEA98113ECF1F7D345",
			"406A5F7A87363EBAE2883F61360B264414C4BAB7120AE7DDD255E6BE626EE01E8C69761170655FA036300E9D8B4403D5F1BA25FFA70E08A73F8AD5276E581A53",
			"BC4B2E59F3DD0A024F94FB829573DBAEE11B0C8EDFACBBD8D7EE702009CAF51DE1E5CCF73BD1CB98351FCAF538240A6F87DD4491ABC8205CD4F0F9426DDAC8E1",
			512,
		},

		// ...

		// Set 6, vector# 3:
		{
			"0F62B5085BAE0154A7FA4DA0F34699EC", "288FF65DC42B92F9",
			"2F77C251FBE7ADEE9950C8A4D9830BB967BAFD9C7E8976D51D86531CBF8BA79B6BFC5D575F20712FB7B31B3D684BE6264445538C66F6F6CB438F0086B4206FEA",
			"ED04B331AF6CA315830D0CCC554D40E1FA49608D94EEF563D520C89D22E04D695BF04C5E919A3F4BBF52CF46EB7CF34E9DA490A8169C5DCBB2E17DF0C5973CB4",
			"85D0F1425B3D1992AE46EEE6118C04750C6858A5C905EEA9634AA063D21B0A6D89B98A94B43B6AB5E1F551F85B4495721B607ECDD5D1D6AD83319B5BCB618EA9",
			"8028FD38017AC0AC73CF0F49767570D0121FB290784670A70E0EB493F0C82557DE601DB84F96B2FEC0DC5B91AF229D4AC9559668445184901E9D443A755EE49F",
			"4F9BF0A751E308FFAC3A483420C0907CD1144AA3E92AFC36E55379BCF140F70D3F52C78322266409B0964AB1DB8634E0B2F0DF908D503C2D74F1BF4C387ED42F",
			131072,
		},

		// 256 bit key

		// Set 1, vector# 0:
		{
			"8000000000000000000000000000000000000000000000000000000000000000",
			"0000000000000000",
			"789CC357F0B6CDA5395F08C8538F1226D08EB3E16EBD6B6DB6CC9CA77D81D900BB9D21F6EF0B720550D161F1A80FAB0468E48C086DAAD356EDCE3A3F988D8E82",
			"217E9FA30A8FF6F3B4CD1BB3F4066682199952F656095712BE188ACE9FA5D06D69DC5DAF8DD0B35D21A475D85960E5F726AA406D2A3D3468B60332706BFEE6CB",
			"B321E18C5A340D6757FB9055D68852B1F71155F439A6666CCAB2D2052841DA0523A32F408039A25F7B243820EDC313BD39D6CAE5DE3F99B93F73EFEC83E9ACC5",
			"6E96ED6EC4BBE5336419D357A065CBE89B7E4C7670B791AD21E733C19E9FBF140B7B8E8665CE490EF0E54EE22D8EA2A54E9AE47049C9069BD47C99D32526C513",
			"24708C8A93162DFB6DC9EB4F6DAABF6EAEDFA1D24A708F0752756E61597674CB432F2C86B5515CA389848C52E5E00089DAAB39EEA5D38C73A4FA3603398DD2C7",
			512,
		},
		// Set 1, vector# 9:
		{
			"0040000000000000000000000000000000000000000000000000000000000000",
			"0000000000000000",
			"5BB03B2B21C277DE6E9E5A7514E98313EABE85845726FA5D4283E0A0275CE2F454B2E7BE9BA52776347E39E4E9B0CAE4FAB32EFBA9E35D336F7FE4C1B872B4D1",
			"B2229BA0F7E74F87A847CBDC1F9868A20AEEB9E9DB3A246387E48748AA31E86294580BC17905BD681870A4D7AFBC3D91317B869A24927EFB4073B8CAA36E1ECC",
			"D2E3D38B2454DA585097C9851274A8F0E723045C6770AB2F6DD75E26F2E592B9F48A07B78690DC35FA891026A9971A5C509F46F6E969B4B30C2B6AAE0018EBD3",
			"C49DD6679B260A6934F8CBBC93EB0D5031935A7241ED8D03C6ED1035AB52B5AA06411543B5853A1352C4D6DC0A14981206AD52452DA6A7A6EB0108155E46B6A6",
			"A4A555D9598F60B4F8AF9F4162DC904C7FCAF822A9275246E5ACE6F60FBDA30CD338FE94060578EF12DFDB2AD095B82F2F09E3A97903860C337C7D0D358A06CF",
			512,
		},
		// Set 1, vector# 18:
		{
			"0000200000000000000000000000000000000000000000000000000000000000",
			"0000000000000000",
			"3186005BFBA3DFB84737147E6236DC8658A4E5DE565B67C63FD8D57582EE260910086F88CAA66CCFD8DFCE68DA7559C6EA6D75B28E72EBB5A68BE29F35E528E7",
			"9C2BAD9BA5A88FCBB791FCDF1CD93EB09CCFD0E6620BE9E734700BE6E1F02DE0247B2BEE8565A41AB8D15DC711CB42181037F6866DA68EC6F592453059EB59C6",
			"D9D14A7C0D4BD7CDC071C88EDFECB71612D71D61A7126EECD99BA28F838FB47A90F44F5E9FD12C646C690355032ADC14A86F9236C4DC52D338775292AD065B2A",
			"37E6D9F97B2184E9DC17233FE5E8989CBB5E5E97E4779AFDD5F20D94BB5700C74FC4ED2E98EF8A2D62769D13203557A3614311B4A99DB096B00DC551F471910A",
			"1C2D56F6F7AE172B780D4B545ADCF1C79A32F8822A4B4AFD0205B1C6E25F8E8F5F0D05E18BC857DD0C3F1ADFE5CECC63E484AED157F2AC8574037CB4FB0F0FFB",
			512,
		},
		// Set 1, vector# 27:
		{
			"0000001000000000000000000000000000000000000000000000000000000000",
			"0000000000000000",
			"10F32EB7FECCE3D42FFDE05E750010230BF1434E0BA64AEBCA3D3C8F77424EB2E901DC19639C95C6A7BFC250ACCB844D881D0BFEB83D94423C4609C9D5DAA008",
			"ABE081717DAEF6209021E36689C7892657C0B1D5979F06E6F2185353F351AA29FE00CD098B244EADD13A1E261CE81821BB6670880191F7DDD7CED21051F25B9E",
			"E3615FFBB04270DAD677B804496ADFC95311FBE115526BE44A4391A561CC1C136C9F2EFF96B2EF645FD212BBE89118F73A96D6DA20887E0F78FF47114EAA1A8E",
			"8E645697EEAAD972BC685D13A9164C991B8EC6C3669CDBBDCFBC1CE14E99642842B4BE1EAB939B4F2A0BD2F2C732AC62D050B14F582BB85B6D5D06B3E5BEE64B",
			"7D442A60D8165640BB2537EDE435923D4EB7605F146BCE673E6B6ABD601D4A6BC8E62DCB1BE3ECA6A583FE3B4052B8E134BCAD8D956166CD7BD3D2FF1B3E348F",
			512,
		},
		// Set 1, vector# 36:
		{
			"0000000008000000000000000000000000000000000000000000000000000000",
			"0000000000000000",
			"35DB5F445AA6A1E7B68069CF8B126BE89C8B7FE9FB3ECA52024064A8A189793EC6E11836B6C3ABCF8FBDAEBB7B5BC37B56A167438AF36BAC171917F6A19F5D9D",
			"0A0994FAC1F0FA1789E7FE6142F1678FF734E166F8B584CF42B5EE77D44F3CAA6F3203AFB494ECD5B430DE9E1ACD1FD723F34A5AB0FFFEFEEA3F8727880199C8",
			"440AFCA771A6969E21AB454158BE670D7639A13834C8906B249F34144CD0A81B83A6CB2E5E3E09E485F64BDE31C46A48090D48C04CA0EDD5CEC29AE58710AED2",
			"9B833D402DE00654E0855AD8B700D8C15DEA68582E213C9674EAD341195E803270406923D1701D263570633D8B92FB3DDB3DD71B6BF2C8AC8A8BAF2EFA79AF5D",
			"76EA992982AE83A65EFAC51B74FA302A69A1BB170BF2477774318337063475DAFFD20DD5C623F80E9624367DE21DABD608965C6870BC192E6C140888FFBE650F",
			512,
		},
		// Set 1, vector# 45:
		{
			"0000000000040000000000000000000000000000000000000000000000000000",
			"0000000000000000",
			"1BA784398B280B70B5DB9E238535D1264E14F173115517FD913CAC848B0FAE8CA67C329C1F1104A264A357754C427BC271F6B5C92A048F94F5A29EEADD492F70",
			"F4B658E4FF78AB7B326A37BB108ACB17847D3D61D6A8092C11A8827D2154EF8655A25AAA0E7A59EB270728BE9DE2196102292DFBFF29F40247E533D32CDAD1A2",
			"4D6CA17C7AB3231BFC803CDB12AE09D0DE05AAFFC955A28FC5C528412D3D86F4A7E116905F7273449915C691D128BA30122524C87BF06DE270497EC717FA8FE0",
			"2676F952411B63164F9A51C59920FF3D1BB72264A677FD8B1296168F88A86F0797D1E847B871E63815A1638D571FB2A4696C530F77067819572E3A983FA0213E",
			"2E22ACD0A01C5F5DF19E3B9809C826C496C52126DF7300D22C01C49B76562600DC73D3C5FAFD632A13AFD554D8AD97592D9E87EA112C76B41222DD54D6E5083B",
			512,
		},
		// Set 1, vector# 54:
		{
			"0000000000000200000000000000000000000000000000000000000000000000",
			"0000000000000000",
			"00598B9A2FD50CDBB5FD49A273C6CC13270E253BDCC31ED23FA9172B12AC8A7FB1E971285404FEEE125B34D3EB7F5D2C86874B8083DD2C38A6923F6C25C4A295",
			"97C31FA1A5BB85AA6FC373FD46AEAA1755D09698D968FB475C8333C016E48D9F24A04CF75B4E51FA81BC2084688660E1ECC6EBFF12AF0CBFEBCB5FC1ABACB651",
			"8FE481AF0AF2DDC505594A5B6ABF04BE4E95480E5644BCE3D1B9836F5657E7D5F270E56137DA29F588690A62B304E6A39E0DC61EC5391977E03378A49602D8AF",
			"25B01FB5A2EBF78D3787019268E39C8A4737FCE30AE7B577287E3AF535940235CEAF086FD293A50BCE337C7A183BA23D1278D45CE0DD0170742774BCB0B7305B",
			"E7A340135E50FC93F6A27CE2A12B8E9B3EF148BCB06CD684C8B717484143730D622F4AA34A8E617BE2BC57271D7FEFF24470651D8A7469C48662B0987706150A",
			512,
		},
		// Set 1, vector# 63:
		{
			"0000000000000001000000000000000000000000000000000000000000000000",
			"0000000000000000",
			"9DCB941858B8D65445F6F3F902FFB23F9D7EEAA2F172F5957E403673BA0E97611C4DBB8D3C66F4D73B6711A593A76B556BEADAEC886B8B11AAD49EA46575D628",
			"EF26F967FB812B0DF6BC4FB22DD71ADF0B723EB2E38B3F7CFBB46902072CE71C29AFCB3092BD7C3D3E442947795C4A5B1D4ED501357A37E851B15A4C96CD4BCF",
			"1B34A8B00929D3AE986AA29A11F8EAC61BE2080A8403DF726DA0B6D507888EA9CE65FBF035A1D0319A1C3494ACBF138052FF8220C5F42DA1418DBDD4FA2A7F82",
			"136E41260BDA59F401A83B472B4587DFEB07637FFD648F22DD9EE87A760B3D2DEB01A84557153000BBCF80EB2BE467DD71D8FC8B27CE3A27996343D16F85047A",
			"E695B97671AC28D4C0FF019C07883CBFCEC03AC65AF3EE71F017D9E5531464B8C3FE339C44BB1D41E50A19020A9086E6DCC5CBABCC2903B2E7A48C84BCD1448C",
			512,
		},

		// ...

		// Set 6, vector# 3:
		{
			"0F62B5085BAE0154A7FA4DA0F34699EC3F92E5388BDE3184D72A7DD02376C91C",
			"288FF65DC42B92F9",
			"49FD8FBF19EDCF3A198F5226AA480B97D9F16BA71A693C4ECB90C276094585DFA4FA259E1EC34DE444C92879BFE7F641EEAC480168DC8969A9C033151B1E9229",
			"0B9E3C3CE162090F45AFF94B98EE59EE4E660B7E307DAEE886772ACAEDD04F3A51ABCBD7C24CE2A866DA9778E209AB8FDF0AB1A9F23E2435B6B889D0434E887F",
			"9E52E1671845FF397F4DBF4A99D88E298575CF3F083F5DD3A3B03B2C1AAA473BF360239CD4444FE05F971E352C871369D65016679CD61B4AB6DA9D34A225622C",
			"D0C3B9895EB7A30570B14E3CD4472E89C2496595374177BF6BB7CC1D99ACBA10F7BFAFD23657E9476887AF2DAC292B5DA02945C1CA26B9D8758E140580CEBFCD",
			"5CF1A20AB3A4FEFB01B08B3200081CDAC2797B44E3096E85F19F4FB72B45C6D9C1B0F8ADD6E25C30D8050069D84097662858B9FC05F5F6E5C0E327E3E29E3B80",
			131072,
		},
	}

	for idx, v := range vectors {
		key, _ := hex.DecodeString(v.key)
		nonce, _ := hex.DecodeString(v.nonce)
		output := make([]byte, v.msgLen)
		n := len(output)

		chachaKeystreamBytes(output[:], nonce, key)

		begining, _ := hex.DecodeString(v.begining)
		l := len(begining)
		if bytes.Compare(begining, output[0:l]) != 0 {
			t.Errorf("[%d]: out[0..] does not match", idx)
		}

		preMiddle, _ := hex.DecodeString(v.preMiddle)
		l = len(preMiddle)
		if bytes.Compare(preMiddle, output[n/2-l:n/2]) != 0 {
			t.Errorf("[%d]: out[..n/2] does not match", idx)
		}

		postMiddle, _ := hex.DecodeString(v.postMiddle)
		l = len(postMiddle)
		if bytes.Compare(postMiddle, output[n/2:n/2+l]) != 0 {
			t.Errorf("[%d]: out[n/2..] does not match", idx)
		}

		end, _ := hex.DecodeString(v.end)
		l = len(end)
		if bytes.Compare(end, output[n-l:n]) != 0 {
			t.Errorf("[%d]: out[..n] does not match", idx)
		}
	}
}
